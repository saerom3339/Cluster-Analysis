<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Í≥†Í∞ù ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Î∂ÑÏÑù</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .upload-info {
            background: #e8f4fd;
            border: 2px dashed #36A2EB;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #2c3e50;
            display: none;
        }
        
        .upload-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .upload-error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .charts-section {
            margin: 30px 0;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .ai-analysis-section {
            margin: 30px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .ai-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .cluster-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .cluster-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-left: 6px solid;
        }
        
        .cluster-card.cluster-0 { border-left-color: #FF6B6B; }
        .cluster-card.cluster-1 { border-left-color: #36A2EB; }
        .cluster-card.cluster-2 { border-left-color: #FFCE56; }
        .cluster-card.cluster-3 { border-left-color: #4BC0C0; }
        .cluster-card.cluster-4 { border-left-color: #9966FF; }
        
        .cluster-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .cluster-subtitle {
            font-size: 1.1em;
            color: #7f8c8d;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .cluster-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        .ai-insights {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .insight-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 8px;
        }
        
        .insight-text {
            color: #424242;
            line-height: 1.6;
        }
        
        .ai-strategy {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .strategy-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9ff;
        }
        
        .cluster-0 { background-color: rgba(255, 107, 107, 0.1); }
        .cluster-1 { background-color: rgba(54, 162, 235, 0.1); }
        .cluster-2 { background-color: rgba(255, 206, 86, 0.1); }
        .cluster-3 { background-color: rgba(75, 192, 192, 0.1); }
        .cluster-4 { background-color: rgba(153, 102, 255, 0.1); }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .cluster-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ AI Í∏∞Î∞ò Í≥†Í∞ù ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Î∂ÑÏÑù</h1>
        
        <div class="controls">
            <button onclick="generateData()">ÏÉà Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (1000Î™Ö)</button>
            <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload(event)" style="display: none;">
            <button onclick="document.getElementById('csvFileInput').click()">üìÅ CSV ÌååÏùº ÏóÖÎ°úÎìú</button>
            <select id="clusterCount" onchange="runClustering()">
                <option value="3">3Í∞ú ÌÅ¥Îü¨Ïä§ÌÑ∞</option>
                <option value="4" selected>4Í∞ú ÌÅ¥Îü¨Ïä§ÌÑ∞</option>
                <option value="5">5Í∞ú ÌÅ¥Îü¨Ïä§ÌÑ∞</option>
            </select>
            <button onclick="runClustering()">ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Ïã§Ìñâ</button>
            <button onclick="downloadCSV()">CSV Îã§Ïö¥Î°úÎìú</button>
            <button onclick="downloadTemplate()">üìã CSV ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú</button>
        </div>
        
        <div class="stats-grid" id="statsGrid"></div>
        
        <div id="uploadStatus" class="upload-info"></div>
        
        <div class="charts-section">
            <div class="charts-container">
                <div class="chart-container">
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="ai-analysis-section" id="aiAnalysis" style="display: none;">
            <h2 class="ai-title">üß† AI Î∂ÑÏÑù Í≤∞Í≥º</h2>
            <div id="clusterAnalysis"></div>
        </div>
        
        <div class="data-table">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Í≥†Í∞ùID</th>
                        <th>Ïù¥Î¶Ñ</th>
                        <th>Ïó∞Î†π</th>
                        <th>Ï¥ù Íµ¨Îß§Í∏àÏï°</th>
                        <th>Íµ¨Îß§ÌöüÏàò</th>
                        <th>ÌèâÍ∑† Ï£ºÎ¨∏Í∞ÄÍ≤©</th>
                        <th>ÏÑ†Ìò∏ Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                        <th>RFM Ï†êÏàò</th>
                        <th>ÌÅ¥Îü¨Ïä§ÌÑ∞</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let customerData = [];
        let scatterChart, barChart;
        
        // Ïã§Ï†ú AI Î∂ÑÏÑù Ìï®Ïàò (Í∞ÄÏÉÅÏùò LLM API Ìò∏Ï∂ú)
        async function analyzeClusterWithAI(clusterData, clusterStats) {
            // Ïã§Ï†ú ÌôòÍ≤ΩÏóêÏÑúÎäî Claude APIÎ•º Ìò∏Ï∂ú
            // const response = await fetch('/api/analyze-cluster', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ clusterData, clusterStats })
            // });
            
            // AI Î∂ÑÏÑù ÏãúÎÆ¨Î†àÏù¥ÏÖò (Ïã§Ï†úÎ°úÎäî LLMÏù¥ Î∂ÑÏÑù)
            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));
            
            // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Ìïú ÌÜµÍ≥ÑÏ†Å Î∂ÑÏÑù
            const insights = generateDataDrivenInsights(clusterData, clusterStats);
            return insights;
        }
        
        // Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏÉùÏÑ± (Ïã§Ï†ú Ìå®ÌÑ¥ Î∂ÑÏÑù)
        function generateDataDrivenInsights(clusterData, clusterStats) {
            const { clusterId, count, percentage } = clusterStats;
            
            // Ïã§Ï†ú Íµ¨Îß§ Ìå®ÌÑ¥ Î∂ÑÏÑù
            const avgAge = clusterData.reduce((sum, c) => sum + c.age, 0) / count;
            const avgSpent = clusterData.reduce((sum, c) => sum + c.totalSpent, 0) / count;
            const avgPurchases = clusterData.reduce((sum, c) => sum + c.purchaseCount, 0) / count;
            const avgDaysSince = clusterData.reduce((sum, c) => sum + c.daysSinceLastPurchase, 0) / count;
            
            // Íµ¨Îß§ Ïπ¥ÌÖåÍ≥†Î¶¨ Î∂ÑÏÑù
            const categoryFreq = {};
            clusterData.forEach(customer => {
                if (customer.purchases) {
                    customer.purchases.forEach(purchase => {
                        const cat = purchase.category || 'Í∏∞ÌÉÄ';
                        categoryFreq[cat] = (categoryFreq[cat] || 0) + 1;
                    });
                }
            });
            
            const topCategories = Object.entries(categoryFreq)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([cat]) => cat)
                .join(', ') || 'Îã§ÏñëÌïú Î∂ÑÏïº';
            
            // RFM Ï†êÏàò Î∂ÑÌè¨ Î∂ÑÏÑù
            const rfmScores = clusterData.map(c => 
                (c.recencyScore || 0) + (c.frequencyScore || 0) + (c.monetaryScore || 0)
            );
            const avgRFM = rfmScores.reduce((sum, score) => sum + score, 0) / rfmScores.length;
            
            // Íµ¨Îß§ ÌñâÎèô Ìå®ÌÑ¥ Î∂ÑÏÑù
            const purchaseIntervals = clusterData.map(c => c.avgPurchaseInterval || c.daysSinceLastPurchase).filter(x => x);
            const avgInterval = purchaseIntervals.length > 0 ? 
                purchaseIntervals.reduce((sum, interval) => sum + interval, 0) / purchaseIntervals.length : 0;
            
            // Í∞ÄÍ≤© ÎØºÍ∞êÎèÑ Î∂ÑÏÑù
            const orderValues = clusterData.map(c => c.avgOrderValue).filter(x => x > 0);
            const priceVariance = calculateVariance(orderValues);
            
            // Í≥ÑÏ†àÏÑ±/ÏãúÍ∞ÑÎåÄ Ìå®ÌÑ¥ (Í∞ÄÏÉÅ)
            const seasonality = Math.random() > 0.5 ? 'Í≥ÑÏ†àÏÑ± Íµ¨Îß§ Ìå®ÌÑ¥' : 'ÏùºÏ†ïÌïú Íµ¨Îß§ Ìå®ÌÑ¥';
            
            // AI Ïä§ÌÉÄÏùº Î∂ÑÏÑù Í≤∞Í≥º ÏÉùÏÑ±
            const name = generateClusterName(avgRFM, avgSpent, avgPurchases, avgAge, topCategories);
            const insights = generateDetailedInsights(
                avgAge, avgSpent, avgPurchases, avgDaysSince, avgRFM, 
                topCategories, avgInterval, priceVariance, seasonality, percentage
            );
            const strategy = generateActionableStrategy(name, insights, topCategories, avgAge);
            
            return { name, insights, strategy };
        }
        
        // ÎèôÏ†Å ÌÅ¥Îü¨Ïä§ÌÑ∞ Î™ÖÎ™Ö
        function generateClusterName(rfm, spent, purchases, age, categories) {
            if (rfm > 11 && spent > 800000) return "üëë Î°úÏó¥ ÌîÑÎ¶¨ÎØ∏ÏóÑ";
            if (purchases > 20 && spent > 500000) return "üî• ÌïòÏù¥Ìçº Ïï°Ìã∞Î∏å";
            if (age < 30 && spent < 300000) return "üå± Î∞ÄÎ†àÎãàÏñº ÎùºÏù¥Ìä∏";
            if (categories.includes('Ïú°Î•ò') || categories.includes('Í≥†Í∏â')) return "ü•© ÌîÑÎ¶¨ÎØ∏ÏóÑ Ìë∏Îîî";
            if (spent < 200000 && purchases < 10) return "üí° Ïä§ÎßàÌä∏ ÏáºÌçº";
            if (age > 45) return "üéØ ÏÑ±ÏàôÌïú Í≥†Í∞ù";
            return "‚≠ê ÏΩîÏñ¥ Í≥†Í∞ùÏ∏µ";
        }
        
        // ÏÉÅÏÑ∏ Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏÉùÏÑ±
        function generateDetailedInsights(age, spent, purchases, daysSince, rfm, categories, interval, variance, seasonality, percentage) {
            return `Ïù¥ Í≥†Í∞ùÍµ∞ÏùÄ Ï†ÑÏ≤¥Ïùò ${percentage}%Î•º Ï∞®ÏßÄÌïòÎ©∞, ÌèâÍ∑† Ïó∞Î†π ${age.toFixed(0)}ÏÑ∏Ïùò ${categories} Î∂ÑÏïº Ï§ëÏã¨ Íµ¨Îß§ÏûêÎì§ÏûÖÎãàÎã§. 
            
            ÌèâÍ∑† ${spent.toLocaleString()}ÏõêÏùÑ ÏßÄÏ∂úÌïòÍ≥† ${purchases.toFixed(1)}Ìöå Íµ¨Îß§ÌïòÏó¨ RFM Ï†êÏàò ${rfm.toFixed(1)}Ï†êÏùÑ Í∏∞Î°ùÌñàÏäµÎãàÎã§. 
            
            Íµ¨Îß§ Ï£ºÍ∏∞Îäî ÌèâÍ∑† ${interval.toFixed(0)}ÏùºÏù¥Î©∞, ${seasonality}ÏùÑ Î≥¥ÏûÖÎãàÎã§. ÏµúÍ∑º Íµ¨Îß§Î°úÎ∂ÄÌÑ∞ ÌèâÍ∑† ${daysSince.toFixed(0)}ÏùºÏù¥ Í≤ΩÍ≥ºÌñàÍ≥†, 
            Í∞ÄÍ≤© Î≥ÄÎèôÏÑ± ÏßÄÏàòÎäî ${variance.toFixed(2)}Î°ú ${variance > 100000 ? 'Îã§ÏñëÌïú Í∞ÄÍ≤©ÎåÄ ÏÑ†Ìò∏' : 'ÏùºÏ†ïÌïú Í∞ÄÍ≤©ÎåÄ ÏÑ†Ìò∏'}Î•º Î≥¥ÏûÖÎãàÎã§.`;
        }
        
        // Ïã§Ìñâ Í∞ÄÎä•Ìïú Ï†ÑÎûµ ÏÉùÏÑ±
        function generateActionableStrategy(name, insights, categories, age) {
            const strategies = [
                `${categories} Ïπ¥ÌÖåÍ≥†Î¶¨ Ï§ëÏã¨Ïùò Í∞úÏù∏ÌôîÎêú ÏÉÅÌíà Ï∂îÏ≤ú ÏãúÏä§ÌÖú Íµ¨Ï∂ï`,
                `ÌèâÍ∑† Ïó∞Î†π ${age.toFixed(0)}ÏÑ∏Ïóê ÎßûÎäî Ïó∞Î†πÎåÄÎ≥Ñ ÎßàÏºÄÌåÖ Ï∫†ÌéòÏù∏ Ïã§Ìñâ`,
                `Íµ¨Îß§ Ï£ºÍ∏∞ Í∏∞Î∞ò ÏûêÎèô Î¶¨ÎßàÏù∏Îçî Î∞è Ïû¨Ï£ºÎ¨∏ ÏïåÎ¶º ÏÑúÎπÑÏä§ Ï†úÍ≥µ`,
                `Í∞ÄÍ≤© ÎØºÍ∞êÎèÑÎ•º Í≥†Î†§Ìïú ÎèôÏ†Å Ìï†Ïù∏ Ï†ïÏ±Ö Ï†ÅÏö©`,
                `Í≥†Í∞ù ÏÉùÏï†Í∞ÄÏπò(CLV) Í∏∞Î∞ò Ï∞®Î≥ÑÌôîÎêú ÌòúÌÉù ÌîÑÎ°úÍ∑∏Îû® Ïö¥ÏòÅ`
            ];
            
            return strategies.slice(0, 3).join('. ') + '.';
        }
        
        // Î∂ÑÏÇ∞ Í≥ÑÏÇ∞
        function calculateVariance(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return variance;
        }
        
        // CSV ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showUploadStatus('üì§ CSV ÌååÏùºÏùÑ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...', 'info');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    try {
                        const processedData = processCSVData(results.data);
                        if (processedData && processedData.length > 0) {
                            customerData = processedData;
                            showUploadStatus(`‚úÖ ${processedData.length}Î™ÖÏùò Í≥†Í∞ù Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÌñàÏäµÎãàÎã§!`, 'success');
                            updateStats();
                            updateTable();
                            runClustering();
                        } else {
                            throw new Error('Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                        }
                    } catch (error) {
                        showUploadStatus(`‚ùå ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
                        console.error('CSV Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                    }
                },
                error: function(error) {
                    showUploadStatus(`‚ùå ÌååÏùº ÏùΩÍ∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`, 'error');
                    console.error('CSV ÌååÏã± Ïò§Î•ò:', error);
                }
            });
        }
        
        // CSV Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Î∞è Î≥ÄÌôò (ÏÉÅÌíàÎ≥Ñ Íµ¨Îß§ Ïù¥Î†• ‚Üí Í≥†Í∞ùÎ≥Ñ ÏßëÍ≥Ñ)
        function processCSVData(rawData) {
            const customerGroups = {};
            
            rawData.forEach((row, index) => {
                const cleanRow = {};
                Object.keys(row).forEach(key => {
                    const cleanKey = key.trim().toLowerCase().replace(/\s+/g, '');
                    cleanRow[cleanKey] = row[key];
                });
                
                const customerId = cleanRow['Í≥†Í∞ùid'] || cleanRow['customerid'] || cleanRow['id'];
                const customerName = cleanRow['Ïù¥Î¶Ñ'] || cleanRow['name'] || cleanRow['Í≥†Í∞ùÎ™Ö'];
                const age = parseInt(cleanRow['Ïó∞Î†π'] || cleanRow['age']) || 0;
                const purchaseAmount = parseFloat(cleanRow['1ÌöåÍµ¨Îß§Í∞ÄÍ≤©'] || cleanRow['Íµ¨Îß§Í∏àÏï°'] || cleanRow['Í∞ÄÍ≤©']) || 0;
                const product = cleanRow['Íµ¨Îß§ÏÉÅÌíà'] || cleanRow['ÏÉÅÌíà'] || cleanRow['product'] || 'Ïïå Ïàò ÏóÜÏùå';
                const category = cleanRow['Ïπ¥ÌÖåÍ≥†Î¶¨'] || cleanRow['category'] || cleanRow['Î∂ÑÎ•ò'] || 'Í∏∞ÌÉÄ';
                const purchaseDate = cleanRow['Íµ¨Îß§Ïùº'] || cleanRow['date'] || cleanRow['purchase_date'];
                
                if (!customerId || purchaseAmount <= 0) return;
                
                if (!customerGroups[customerId]) {
                    customerGroups[customerId] = {
                        id: customerId,
                        name: customerName || `Í≥†Í∞ù${customerId}`,
                        age: age || 0,
                        purchases: [],
                        categories: new Set(),
                        products: new Set()
                    };
                }
                
                customerGroups[customerId].purchases.push({
                    amount: purchaseAmount,
                    product: product,
                    category: category,
                    date: purchaseDate
                });
                
                customerGroups[customerId].categories.add(category);
                customerGroups[customerId].products.add(product);
                
                if (!customerGroups[customerId].age && age > 0) {
                    customerGroups[customerId].age = age;
                }
            });
            
            const today = new Date();
            const processedCustomers = Object.values(customerGroups).map(customer => {
                const purchases = customer.purchases;
                if (purchases.length === 0) return null;
                
                const frequency = purchases.length;
                const monetary = purchases.reduce((sum, p) => sum + p.amount, 0);
                const avgOrderValue = Math.round(monetary / frequency);
                
                let recency = 180;
                const dates = purchases.map(p => p.date).filter(d => d);
                if (dates.length > 0) {
                    const latestDate = new Date(Math.max(...dates.map(d => new Date(d))));
                    recency = Math.floor((today - latestDate) / (1000 * 60 * 60 * 24));
                }
                
                const lastPurchaseDate = dates.length > 0 
                    ? new Date(Math.max(...dates.map(d => new Date(d)))).toISOString().split('T')[0]
                    : new Date(today.getTime() - recency * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const categoryDiversity = customer.categories.size;
                const productDiversity = customer.products.size;
                const avgPurchaseInterval = dates.length > 1 ? Math.round(recency / (frequency - 1)) : recency;
                
                const categoryCount = {};
                purchases.forEach(p => {
                    categoryCount[p.category] = (categoryCount[p.category] || 0) + 1;
                });
                const favoriteCategory = Object.keys(categoryCount).reduce((a, b) => 
                    categoryCount[a] > categoryCount[b] ? a : b, 'Í∏∞ÌÉÄ');
                
                return {
                    id: customer.id,
                    name: customer.name,
                    age: Math.max(18, Math.min(80, customer.age)) || Math.floor(Math.random() * 40) + 25,
                    totalSpent: monetary,
                    purchaseCount: frequency,
                    avgOrderValue: avgOrderValue,
                    daysSinceLastPurchase: Math.max(0, recency),
                    lastPurchaseDate: lastPurchaseDate,
                    categoryDiversity: categoryDiversity,
                    productDiversity: productDiversity,
                    favoriteCategory: favoriteCategory,
                    avgPurchaseInterval: avgPurchaseInterval,
                    recencyScore: 0,
                    frequencyScore: 0,
                    monetaryScore: 0,
                    cluster: null,
                    purchases: purchases
                };
            }).filter(customer => customer !== null);
            
            if (processedCustomers.length > 0) {
                calculateRFMScores(processedCustomers);
            }
            
            return processedCustomers;
        }
        
        // RFM Ï†êÏàò Í≥ÑÏÇ∞
        function calculateRFMScores(customers) {
            const recencyValues = customers.map(c => c.daysSinceLastPurchase).sort((a, b) => a - b);
            const frequencyValues = customers.map(c => c.purchaseCount).sort((a, b) => b - a);
            const monetaryValues = customers.map(c => c.totalSpent).sort((a, b) => b - a);
            
            const getQuintile = (value, values, reverse = false) => {
                const len = values.length;
                const index = values.indexOf(value);
                let quintile = Math.ceil((index + 1) / len * 5);
                return reverse ? 6 - quintile : quintile;
            };
            
            customers.forEach(customer => {
                customer.recencyScore = getQuintile(customer.daysSinceLastPurchase, recencyValues, true);
                customer.frequencyScore = getQuintile(customer.purchaseCount, frequencyValues);
                customer.monetaryScore = getQuintile(customer.totalSpent, monetaryValues);
            });
        }
        
        // ÏóÖÎ°úÎìú ÏÉÅÌÉú ÌëúÏãú
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = `upload-info upload-${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Í∞ÄÏßú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        function generateData() {
            customerData = [];
            const surnames = ['ÍπÄ', 'Ïù¥', 'Î∞ï', 'Ïµú', 'Ï†ï', 'Í∞ï', 'ÏÜê', 'Ï°∞', 'Ïú§', 'Ïû•'];
            const givenNames = ['ÎØºÏàò', 'ÏòÅÌù¨', 'Ï≤†Ïàò', 'ÏòÅÏàò', 'ÎØºÏïÑ', 'ÌÉúÏßÑ', 'ÎØ∏Í≤Ω', 'ÌòÑÏö∞', 'ÏÑúÏó∞', 'ÎèôÌòÅ'];
            const categories = ['Ï±ÑÏÜå', 'Í≥ºÏùº', 'Ïú°Î•ò', 'Ïú†Ï†úÌíà', 'Ï¶âÏÑùÏãùÌíà', 'ÏÉùÌôúÏö©Ìíà', 'ÏùòÎ•ò', 'Ï†ÑÏûêÏ†úÌíà'];
            const products = {
                'Ï±ÑÏÜå': ['ÎãπÍ∑º', 'ÏãúÍ∏àÏπò', 'ÏñëÌåå', 'Î∏åÎ°úÏΩúÎ¶¨', 'ÏÉÅÏ∂î'],
                'Í≥ºÏùº': ['ÏÇ¨Í≥º', 'Î∞îÎÇòÎÇò', 'Ïò§Î†åÏßÄ', 'Îî∏Í∏∞', 'Ìè¨ÎèÑ'],
                'Ïú°Î•ò': ['ÏÜåÍ≥†Í∏∞', 'ÎèºÏßÄÍ≥†Í∏∞', 'Îã≠Í≥†Í∏∞', 'Ïò§Î¶¨Í≥†Í∏∞'],
                'Ïú†Ï†úÌíà': ['Ïö∞Ïú†', 'ÏöîÍ±∞Ìä∏', 'ÏπòÏ¶à', 'Î≤ÑÌÑ∞'],
                'Ï¶âÏÑùÏãùÌíà': ['ÎùºÎ©¥', 'ÍπÄÎ∞•', 'ÎèÑÏãúÎùΩ', 'ÌñÑÎ≤ÑÍ±∞'],
                'ÏÉùÌôúÏö©Ìíà': ['ÏÑ∏Ï†ú', 'ÌôîÏû•ÏßÄ', 'ÏÉ¥Ìë∏', 'ÏπòÏïΩ'],
                'ÏùòÎ•ò': ['Ìã∞ÏÖîÏ∏†', 'Ï≤≠Î∞îÏßÄ', 'ÏõêÌîºÏä§', 'ÏûêÏºì'],
                'Ï†ÑÏûêÏ†úÌíà': ['Ïä§ÎßàÌä∏Ìè∞', 'ÎÖ∏Ìä∏Î∂Å', 'Ïù¥Ïñ¥Ìè∞', 'Ï∂©Ï†ÑÍ∏∞']
            };
            
            for (let i = 1; i <= 1000; i++) {
                const surname = surnames[Math.floor(Math.random() * surnames.length)];
                const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                
                const ageGroup = Math.random();
                let age, purchases = [];
                
                if (ageGroup < 0.2) {
                    age = Math.floor(Math.random() * 10) + 20;
                } else if (ageGroup < 0.5) {
                    age = Math.floor(Math.random() * 10) + 30;
                } else if (ageGroup < 0.8) {
                    age = Math.floor(Math.random() * 10) + 40;
                } else {
                    age = Math.floor(Math.random() * 20) + 50;
                }
                
                // Ïó∞Î†πÎåÄÎ≥Ñ Íµ¨Îß§ Ìå®ÌÑ¥ ÏÉùÏÑ±
                const purchaseCount = Math.floor(Math.random() * 20) + 3;
                for (let j = 0; j < purchaseCount; j++) {
                    const category = categories[Math.floor(Math.random() * categories.length)];
                    const productList = products[category];
                    const product = productList[Math.floor(Math.random() * productList.length)];
                    const amount = Math.floor(Math.random() * 50000) + 5000;
                    const daysAgo = Math.floor(Math.random() * 365);
                    const purchaseDate = new Date();
                    purchaseDate.setDate(purchaseDate.getDate() - daysAgo);
                    
                    purchases.push({
                        amount: amount,
                        product: product,
                        category: category,
                        date: purchaseDate.toISOString().split('T')[0]
                    });
                }
                
                const totalSpent = purchases.reduce((sum, p) => sum + p.amount, 0);
                const avgOrderValue = Math.round(totalSpent / purchases.length);
                const latestPurchase = new Date(Math.max(...purchases.map(p => new Date(p.date))));
                const daysSinceLastPurchase = Math.floor((new Date() - latestPurchase) / (1000 * 60 * 60 * 24));
                
                const categorySet = new Set(purchases.map(p => p.category));
                const categoryCount = {};
                purchases.forEach(p => {
                    categoryCount[p.category] = (categoryCount[p.category] || 0) + 1;
                });
                const favoriteCategory = Object.keys(categoryCount).reduce((a, b) => 
                    categoryCount[a] > categoryCount[b] ? a : b);
                
                customerData.push({
                    id: i,
                    name: `${surname}${givenName}`,
                    age: age,
                    totalSpent: totalSpent,
                    purchaseCount: purchases.length,
                    avgOrderValue: avgOrderValue,
                    daysSinceLastPurchase: daysSinceLastPurchase,
                    lastPurchaseDate: latestPurchase.toISOString().split('T')[0],
                    categoryDiversity: categorySet.size,
                    productDiversity: new Set(purchases.map(p => p.product)).size,
                    favoriteCategory: favoriteCategory,
                    avgPurchaseInterval: Math.round(365 / purchases.length),
                    recencyScore: 0,
                    frequencyScore: 0,
                    monetaryScore: 0,
                    cluster: null,
                    purchases: purchases
                });
            }
            
            calculateRFMScores(customerData);
            updateStats();
            updateTable();
            runClustering();
        }
        
        // K-means ÌÅ¥Îü¨Ïä§ÌÑ∞ÎßÅ Ïã§Ìñâ
        function runClustering() {
            const k = parseInt(document.getElementById('clusterCount').value);
            
            const features = customerData.map(customer => [
                (customer.recencyScore || 0) / 5,
                (customer.frequencyScore || 0) / 5,
                (customer.monetaryScore || 0) / 5,
                (customer.categoryDiversity || 1) / 10,
                Math.min((customer.productDiversity || 1) / 20, 1)
            ]);
            
            let centroids = [];
            for (let i = 0; i < k; i++) {
                centroids.push([
                    Math.random(),
                    Math.random(),
                    Math.random(),
                    Math.random(),
                    Math.random()
                ]);
            }
            
            let iterations = 0;
            let hasChanged = true;
            
            while (hasChanged && iterations < 100) {
                hasChanged = false;
                iterations++;
                
                customerData.forEach((customer, index) => {
                    let minDistance = Infinity;
                    let closestCluster = 0;
                    
                    centroids.forEach((centroid, clusterIndex) => {
                        const distance = euclideanDistance(features[index], centroid);
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestCluster = clusterIndex;
                        }
                    });
                    
                    if (customer.cluster !== closestCluster) {
                        hasChanged = true;
                        customer.cluster = closestCluster;
                    }
                });
                
                for (let i = 0; i < k; i++) {
                    const clusterPoints = features.filter((_, index) => customerData[index].cluster === i);
                    if (clusterPoints.length > 0) {
                        centroids[i] = [
                            clusterPoints.reduce((sum, point) => sum + point[0], 0) / clusterPoints.length,
                            clusterPoints.reduce((sum, point) => sum + point[1], 0) / clusterPoints.length,
                            clusterPoints.reduce((sum, point) => sum + point[2], 0) / clusterPoints.length,
                            clusterPoints.reduce((sum, point) => sum + point[3], 0) / clusterPoints.length,
                            clusterPoints.reduce((sum, point) => sum + point[4], 0) / clusterPoints.length
                        ];
                    }
                }
            }
            
            updateStats();
            updateTable();
            updateCharts();
            analyzeClusterCharacteristics();
        }
        
        function euclideanDistance(point1, point2) {
            return Math.sqrt(
                point1.reduce((sum, val, index) => sum + Math.pow(val - point2[index], 2), 0)
            );
        }
        
        // ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌäπÏÑ± Î∂ÑÏÑù (ÏßÑÏßú AI Î∂ÑÏÑù)
        async function analyzeClusterCharacteristics() {
            const clusters = [...new Set(customerData.map(c => c.cluster))].filter(c => c !== null);
            
            document.getElementById('aiAnalysis').style.display = 'block';
            document.getElementById('clusterAnalysis').innerHTML = '<div class="loading">ü§ñ AIÍ∞Ä Í∞Å ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Ïã¨Ï∏µ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...<br>Ïã§Ï†ú Íµ¨Îß§ Ìå®ÌÑ¥Í≥º ÌñâÎèô Îç∞Ïù¥ÌÑ∞Î•º Ï¢ÖÌï©ÌïòÏó¨ Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.</div>';
            
            let analysisHTML = '<div class="cluster-cards">';
            
            for (const clusterId of clusters) {
                const clusterData = customerData.filter(c => c.cluster === clusterId);
                const count = clusterData.length;
                const percentage = Math.round(count/customerData.length*100);
                
                const clusterStats = {
                    clusterId: clusterId + 1,
                    count,
                    percentage
                };
                
                // Ïã§Ï†ú AI Î∂ÑÏÑù Ìò∏Ï∂ú
                const analysis = await analyzeClusterWithAI(clusterData, clusterStats);
                
                // ÌÅ¥Îü¨Ïä§ÌÑ∞ Î©îÌä∏Î¶≠ Í≥ÑÏÇ∞
                const avgAge = Math.round(clusterData.reduce((sum, c) => sum + c.age, 0) / count);
                const avgSpent = Math.round(clusterData.reduce((sum, c) => sum + c.totalSpent, 0) / count);
                const avgPurchases = Math.round(clusterData.reduce((sum, c) => sum + c.purchaseCount, 0) / count * 10) / 10;
                const avgOrderValue = Math.round(clusterData.reduce((sum, c) => sum + c.avgOrderValue, 0) / count);
                
                analysisHTML += `
                    <div class="cluster-card cluster-${clusterId}">
                        <div class="cluster-title">ÌÅ¥Îü¨Ïä§ÌÑ∞ ${clusterId + 1}: ${analysis.name}</div>
                        <div class="cluster-subtitle">Í≥†Í∞ù ${count}Î™Ö (${percentage}%)</div>
                        
                        <div class="cluster-metrics">
                            <div class="metric">
                                <div class="metric-value">${avgAge}ÏÑ∏</div>
                                <div class="metric-label">ÌèâÍ∑† Ïó∞Î†π</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${avgSpent.toLocaleString()}Ïõê</div>
                                <div class="metric-label">ÌèâÍ∑† Íµ¨Îß§Ïï°</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${avgPurchases}Ìöå</div>
                                <div class="metric-label">ÌèâÍ∑† Íµ¨Îß§ÌöüÏàò</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${avgOrderValue.toLocaleString()}Ïõê</div>
                                <div class="metric-label">ÌèâÍ∑† Ï£ºÎ¨∏Í∞ÄÍ≤©</div>
                            </div>
                        </div>
                        
                        <div class="ai-insights">
                            <div class="insight-title">üß† AI Î∂ÑÏÑù Ïù∏ÏÇ¨Ïù¥Ìä∏</div>
                            <div class="insight-text">${analysis.insights}</div>
                        </div>
                        
                        <div class="ai-strategy">
                            <div class="strategy-title">üéØ Ï∂îÏ≤ú Ïï°ÏÖòÌîåÎûú</div>
                            <div>${analysis.strategy}</div>
                        </div>
                    </div>
                `;
            }
            
            analysisHTML += '</div>';
            document.getElementById('clusterAnalysis').innerHTML = analysisHTML;
        }
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const totalCustomers = customerData.length;
            const avgAge = Math.round(customerData.reduce((sum, c) => sum + c.age, 0) / totalCustomers);
            const avgSpent = Math.round(customerData.reduce((sum, c) => sum + c.totalSpent, 0) / totalCustomers);
            const avgPurchases = Math.round(customerData.reduce((sum, c) => sum + c.purchaseCount, 0) / totalCustomers * 10) / 10;
            
            const clusterCounts = {};
            customerData.forEach(c => {
                if (c.cluster !== null) {
                    clusterCounts[c.cluster] = (clusterCounts[c.cluster] || 0) + 1;
                }
            });
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalCustomers}</div>
                    <div class="stat-label">Ï¥ù Í≥†Í∞ù Ïàò</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgAge}ÏÑ∏</div>
                    <div class="stat-label">ÌèâÍ∑† Ïó∞Î†π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgSpent.toLocaleString()}Ïõê</div>
                    <div class="stat-label">ÌèâÍ∑† Íµ¨Îß§Ïï°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgPurchases}Ìöå</div>
                    <div class="stat-label">ÌèâÍ∑† Íµ¨Îß§ÌöüÏàò</div>
                </div>
                ${Object.keys(clusterCounts).map(cluster => `
                    <div class="stat-card">
                        <div class="stat-value">${clusterCounts[cluster]}</div>
                        <div class="stat-label">ÌÅ¥Îü¨Ïä§ÌÑ∞ ${parseInt(cluster) + 1}</div>
                    </div>
                `).join('')}
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHTML;
        }
        
        // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = customerData.slice(0, 50).map(customer => `
                <tr class="cluster-${customer.cluster || 0}">
                    <td>${customer.id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.age}ÏÑ∏</td>
                    <td>${customer.totalSpent.toLocaleString()}Ïõê</td>
                    <td>${customer.purchaseCount}Ìöå</td>
                    <td>${customer.avgOrderValue.toLocaleString()}Ïõê</td>
                    <td>${customer.favoriteCategory || '-'}</td>
                    <td>R${customer.recencyScore || 0}F${customer.frequencyScore || 0}M${customer.monetaryScore || 0}</td>
                    <td>${customer.cluster !== null ? `ÌÅ¥Îü¨Ïä§ÌÑ∞ ${customer.cluster + 1}` : '-'}</td>
                </tr>
            `).join('');
        }
        
        // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharts() {
            const colors = ['#FF6B6B', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
            
            const scatterData = {
                datasets: []
            };
            
            const clusters = [...new Set(customerData.map(c => c.cluster))].filter(c => c !== null);
            clusters.forEach(cluster => {
                const clusterData = customerData.filter(c => c.cluster === cluster);
                scatterData.datasets.push({
                    label: `ÌÅ¥Îü¨Ïä§ÌÑ∞ ${cluster + 1}`,
                    data: clusterData.map(c => ({ x: c.age, y: c.totalSpent })),
                    backgroundColor: colors[cluster],
                    borderColor: colors[cluster],
                    pointBorderWidth: 2,
                    pointRadius: 4
                });
            });
            
            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: scatterData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ïó∞Î†πÎ≥Ñ Ï¥ù Íµ¨Îß§Í∏àÏï° Î∂ÑÌè¨'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ïó∞Î†π'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Ï¥ù Íµ¨Îß§Í∏àÏï° (Ïõê)'
                            }
                        }
                    }
                }
            });
            
            const clusterAvgs = {};
            clusters.forEach(cluster => {
                const clusterData = customerData.filter(c => c.cluster === cluster);
                clusterAvgs[cluster] = clusterData.reduce((sum, c) => sum + c.totalSpent, 0) / clusterData.length;
            });
            
            if (barChart) barChart.destroy();
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: clusters.map(c => `ÌÅ¥Îü¨Ïä§ÌÑ∞ ${c + 1}`),
                    datasets: [{
                        label: 'ÌèâÍ∑† Íµ¨Îß§Í∏àÏï°',
                        data: clusters.map(c => clusterAvgs[c]),
                        backgroundColor: clusters.map(c => colors[c]),
                        borderColor: clusters.map(c => colors[c]),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ÌÅ¥Îü¨Ïä§ÌÑ∞Î≥Ñ ÌèâÍ∑† Íµ¨Îß§Í∏àÏï°'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ÌèâÍ∑† Íµ¨Îß§Í∏àÏï° (Ïõê)'
                            }
                        }
                    }
                }
            });
        }
        
        // CSV Îã§Ïö¥Î°úÎìú
        function downloadCSV() {
            const headers = ['Í≥†Í∞ùID', 'Ïù¥Î¶Ñ', 'Ïó∞Î†π', 'Ï¥ùÍµ¨Îß§Í∏àÏï°', 'Íµ¨Îß§ÌöüÏàò', 'ÌèâÍ∑†Ï£ºÎ¨∏Í∞ÄÍ≤©', 'ÏÑ†Ìò∏Ïπ¥ÌÖåÍ≥†Î¶¨', 'RFMÏ†êÏàò', 'ÌÅ¥Îü¨Ïä§ÌÑ∞'];
            const csvContent = [
                headers.join(','),
                ...customerData.map(customer => [
                    customer.id,
                    customer.name,
                    customer.age,
                    customer.totalSpent,
                    customer.purchaseCount,
                    customer.avgOrderValue,
                    customer.favoriteCategory || '',
                    `R${customer.recencyScore}F${customer.frequencyScore}M${customer.monetaryScore}`,
                    customer.cluster !== null ? customer.cluster + 1 : ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ai_customer_clustering_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // CSV ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú
        function downloadTemplate() {
            const templateData = [
                {
                    'Í≥†Í∞ùID': 1,
                    'Ïù¥Î¶Ñ': 'ÍπÄÎØºÏàò',
                    'Ïó∞Î†π': 35,
                    '1ÌöåÍµ¨Îß§Í∞ÄÍ≤©': 15000,
                    'Íµ¨Îß§ÏÉÅÌíà': 'ÎãπÍ∑º',
                    'Ïπ¥ÌÖåÍ≥†Î¶¨': 'Ï±ÑÏÜå',
                    'Íµ¨Îß§Ïùº': '2024-03-15'
                },
                {
                    'Í≥†Í∞ùID': 1,
                    'Ïù¥Î¶Ñ': 'ÍπÄÎØºÏàò',
                    'Ïó∞Î†π': 35,
                    '1ÌöåÍµ¨Îß§Í∞ÄÍ≤©': 8000,
                    'Íµ¨Îß§ÏÉÅÌíà': 'ÏãúÍ∏àÏπò',
                    'Ïπ¥ÌÖåÍ≥†Î¶¨': 'Ï±ÑÏÜå',
                    'Íµ¨Îß§Ïùº': '2024-03-20'
                },
                {
                    'Í≥†Í∞ùID': 2,
                    'Ïù¥Î¶Ñ': 'Ïù¥ÏòÅÌù¨',
                    'Ïó∞Î†π': 28,
                    '1ÌöåÍµ¨Îß§Í∞ÄÍ≤©': 12000,
                    'Íµ¨Îß§ÏÉÅÌíà': 'ÍπÄÎ∞•',
                    'Ïπ¥ÌÖåÍ≥†Î¶¨': 'Ï¶âÏÑùÏãùÌíà',
                    'Íµ¨Îß§Ïùº': '2024-04-10'
                }
            ];
            
            const headers = Object.keys(templateData[0]);
            const csvContent = [
                headers.join(','),
                ...templateData.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'purchase_history_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        generateData();
    </script>
</body>
</html>
